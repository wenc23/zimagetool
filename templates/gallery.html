{% extends "layout.html" %}

{% block title %}图片画廊 - Z-Image-Turbo{% endblock %}

{% block content %}
<div class="gallery-page">
    <div class="gallery-header">
        <div class="d-flex justify-between align-center">
            <div>
                <h1><i class="fas fa-images"></i> 图片画廊</h1>
                <p class="subtitle">浏览和管理所有生成的图片</p>
            </div>
            <div class="gallery-actions d-flex gap-2">
                <a href="{{ url_for('index') }}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i> 返回生成器
                </a>
                <button id="refreshGallery" class="btn btn-outline">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
        </div>
    </div>

    {% if images %}
    <div class="gallery-grid">
        {% for image in images %}
        <div class="gallery-card">
            <div class="gallery-image-wrapper">
                <img src="{{ image.path }}" alt="{{ image.name }}" loading="lazy">
                <div class="gallery-overlay">
                    <div class="overlay-buttons">
                        <button class="btn btn-light btn-sm view-details"
                                data-image='{{ image|tojson }}'
                                data-folder="{{ image.folder }}"
                                title="查看详情">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <a href="{{ image.path }}" download
                           class="btn btn-secondary btn-sm"
                           title="下载图片">
                            <i class="fas fa-download"></i>
                        </a>
                        <button class="btn btn-danger btn-sm delete-image"
                                data-folder="{{ image.folder }}"
                                title="删除图片">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="gallery-info">
                <h4 class="image-name">{{ image.name }}</h4>
                <p class="image-folder"><i class="fas fa-folder"></i> {{ image.folder }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-gallery">
        <div class="empty-content">
            <i class="fas fa-image fa-5x"></i>
            <h2>画廊为空</h2>
            <p>还没有生成任何图片，快去生成第一张图片吧！</p>
            <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-magic"></i> 开始生成
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- 图片详情模态框 -->
<div id="imageModal" class="modal" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> 图片详情</h3>
                <button class="modal-close-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-image-section">
                    <img id="modalImage" src="" alt="">
                </div>
                <div class="modal-info-section">
                    <h4 id="modalImageName"></h4>
                    <div id="modalImageInfo" class="image-details"></div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-actions d-flex gap-2 justify-between">
                    <a id="modalDownloadBtn" href="#" download class="btn btn-secondary">
                        <i class="fas fa-download"></i> 下载图片
                    </a>
                    <div class="d-flex gap-2">
                        <button id="modalDeleteBtn" class="btn btn-danger">
                            <i class="fas fa-trash"></i> 删除图片
                        </button>
                        <button class="btn btn-outline" onclick="closeModal()">
                            <i class="fas fa-times"></i> 关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentFolder = null;

    // 刷新按钮
    document.getElementById('refreshGallery')?.addEventListener('click', function() {
        window.location.reload();
    });

    // 图片详情模态框
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalImageName = document.getElementById('modalImageName');
    const modalImageInfo = document.getElementById('modalImageInfo');
    const modalDownloadBtn = document.getElementById('modalDownloadBtn');
    const modalDeleteBtn = document.getElementById('modalDeleteBtn');

    // 显示图片详情
    document.querySelectorAll('.view-details').forEach(button => {
        button.addEventListener('click', function() {
            const imageData = JSON.parse(this.dataset.image);
            currentFolder = this.dataset.folder;

            modalImage.src = imageData.path;
            modalImageName.textContent = imageData.name;
            modalDownloadBtn.href = imageData.path;

            // 显示图片信息
            let infoHtml = '<div class="info-grid">';
            if (imageData.info && Object.keys(imageData.info).length > 0) {
                for (const [key, value] of Object.entries(imageData.info)) {
                    infoHtml += `
                        <div class="info-item">
                            <span class="info-label">${key}:</span>
                            <span class="info-value">${value}</span>
                        </div>
                    `;
                }
                infoHtml += '</div>';
            } else {
                infoHtml = '<p class="text-center text-secondary">暂无详细信息</p>';
            }
            modalImageInfo.innerHTML = infoHtml;

            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        });
    });

    // 删除按钮
    document.querySelectorAll('.delete-image').forEach(button => {
        button.addEventListener('click', async function() {
            const folder = this.dataset.folder;
            const galleryCard = this.closest('.gallery-card');

            if (confirm(`确定要删除这张图片吗?\n文件夹: ${folder}`)) {
                try {
                    const response = await fetch('/api/gallery/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder_name: folder })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // 添加淡出动画
                        galleryCard.style.opacity = '0';
                        galleryCard.style.transform = 'scale(0.8)';
                        setTimeout(() => {
                            galleryCard.remove();
                            // 如果画廊为空，刷新页面
                            if (document.querySelectorAll('.gallery-card').length === 0) {
                                window.location.reload();
                            }
                        }, 300);

                        showNotification('✅ ' + data.message, 'success');
                    } else {
                        showNotification('❌ ' + data.message, 'error');
                    }
                } catch (error) {
                    showNotification('❌ 删除失败', 'error');
                }
            }
        });
    });

    // 模态框中的删除按钮
    modalDeleteBtn?.addEventListener('click', async function() {
        if (!currentFolder) return;

        if (confirm(`确定要删除这张图片吗?\n文件夹: ${currentFolder}`)) {
            try {
                const response = await fetch('/api/gallery/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_name: currentFolder })
                });

                const data = await response.json();

                if (data.success) {
                    closeModal();
                    setTimeout(() => window.location.reload(), 500);
                    showNotification('✅ ' + data.message, 'success');
                } else {
                    showNotification('❌ ' + data.message, 'error');
                }
            } catch (error) {
                showNotification('❌ 删除失败', 'error');
            }
        }
    });

    // 关闭模态框函数
    window.closeModal = function() {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    };

    // 点击模态框背景关闭
    modal?.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // ESC键关闭模态框
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
        }
    });
});
</script>

<style>
.gallery-page {
    animation: fadeIn 0.5s ease;
}

.gallery-header {
    margin-bottom: 2rem;
}

.gallery-header h1 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
}

.gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
    animation: slideUp 0.5s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.gallery-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    transition: var(--transition);
}

.gallery-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-lg);
}

.gallery-image-wrapper {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    background: var(--bg-tertiary);
}

.gallery-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.gallery-card:hover .gallery-image-wrapper img {
    transform: scale(1.1);
}

.gallery-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: var(--transition);
}

.gallery-card:hover .gallery-overlay {
    opacity: 1;
}

.overlay-buttons {
    display: flex;
    gap: 0.75rem;
    animation: scaleIn 0.3s ease;
}

@keyframes scaleIn {
    from {
        transform: scale(0.8);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.overlay-buttons .btn {
    width: 45px;
    height: 45px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.gallery-info {
    padding: 1.25rem;
    background: var(--card-bg);
}

.gallery-info h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.image-folder {
    margin: 0;
    color: var(--text-tertiary);
    font-size: 0.875rem;
}

.image-folder i {
    margin-right: 0.5rem;
}

.empty-gallery {
    text-align: center;
    padding: 4rem 2rem;
    animation: fadeIn 0.5s ease;
}

.empty-content i {
    color: var(--text-tertiary);
    margin-bottom: 1.5rem;
    opacity: 0.3;
}

.empty-content h2 {
    margin: 1rem 0;
    color: var(--text-primary);
}

.empty-content p {
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

/* 模态框样式 */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.show {
    opacity: 1;
}

.modal-dialog {
    width: 100%;
    max-width: 1000px;
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-30px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-content {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.modal-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close-btn:hover {
    background: var(--bg-primary);
    color: var(--danger-color);
}

.modal-body {
    display: flex;
    max-height: 70vh;
    overflow: hidden;
}

@media (max-width: 768px) {
    .modal-body {
        flex-direction: column;
    }
}

.modal-image-section {
    flex: 1;
    background: var(--bg-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    min-height: 400px;
}

.modal-image-section img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: var(--radius-md);
}

.modal-info-section {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
    max-width: 400px;
    background: var(--card-bg);
}

.modal-info-section h4 {
    margin: 0 0 1.5rem 0;
    color: var(--primary-color);
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.image-details {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.info-grid {
    display: grid;
    gap: 1rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--primary-color);
}

.info-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.info-value {
    color: var(--text-primary);
    word-break: break-word;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}

.modal-actions {
    flex-wrap: wrap;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .gallery-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }

    .modal {
        padding: 1rem;
    }

    .modal-info-section {
        max-width: none;
    }

    .modal-actions {
        flex-direction: column;
    }

    .modal-actions .btn {
        width: 100%;
    }
}
</style>
{% endblock %}
